<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>네이버 키워드 검색량 조회</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f8f9fa;
      color: #212529;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e9ecef;
    }
    .header h1 {
      color: #4CAF50;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .header p {
      color: #6c757d;
      font-size: 16px;
    }
    .search-box {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .search-input {
      position: relative;
      margin-bottom: 15px;
    }
    .search-input textarea {
      width: 100%;
      height: 100px;
      padding: 15px;
      border: 2px solid #e9ecef;
      border-radius: 5px;
      font-size: 16px;
      resize: none;
    }
    .search-input textarea:focus {
      border-color: #4CAF50;
      outline: none;
    }
    .search-button {
      display: block;
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    .search-button:hover {
      background: #388E3C;
    }
    .search-button:disabled {
      background: #9E9E9E;
      cursor: not-allowed;
    }
    .search-tips {
      margin-top: 10px;
      color: #6c757d;
      font-size: 14px;
    }
    .results-table {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background: #f8f9fa;
      padding: 15px;
      text-align: center;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #e9ecef;
    }
    td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .keyword-link {
      color: #007bff;
      text-decoration: none;
      font-weight: 500;
    }
    .keyword-link:hover {
      text-decoration: underline;
    }
    .external-link {
      color: #28a745;
      margin-left: 5px;
    }
    .error-message {
      color: #dc3545;
      font-weight: 500;
    }
    .loading {
      text-align: center;
      padding: 30px;
      color: #6c757d;
    }
    .loading i {
      margin-right: 10px;
    }
    .no-results {
      padding: 30px;
      text-align: center;
      color: #6c757d;
    }
    .graph-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .graph-title {
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
      color: #495057;
    }
    .graph-canvas {
      width: 100%;
      height: 300px;
    }
    .footer {
      text-align: center;
      margin-top: 50px;
      padding-top: 20px;
      border-top: 1px solid #e9ecef;
      color: #6c757d;
      font-size: 14px;
    }
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      .search-box {
        padding: 15px;
      }
      th, td {
        padding: 10px 5px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>네이버 키워드 검색량 조회</h1>
      <p>네이버 API를 통해 키워드 검색량을 조회합니다</p>
    </div>

    <div class="search-box">
      <div class="search-input">
        <textarea id="keywordInput" placeholder="검색할 키워드를 입력하세요. 쉼표(,)로 구분하여 여러 키워드를 검색할 수 있습니다. (최대 5개)"></textarea>
      </div>
      <button id="searchButton" class="search-button">
        <i class="fa fa-search"></i> 검색하기
      </button>
      <div class="search-tips">
        <p>* 쉼표(,)로 구분하여 최대 5개까지 키워드를 한 번에 검색할 수 있습니다.</p>
        <p>* 특수문자는 검색이 불가능합니다.</p>
        <p>* 실제 데이터만 표시됩니다. API 호출에 실패할 경우 오류 메시지가 표시됩니다.</p>
      </div>
    </div>

    <div class="graph-container" id="graphContainer" style="display: none;">
      <div class="graph-title">월별 검색량 그래프</div>
      <canvas id="searchVolumeChart" class="graph-canvas"></canvas>
    </div>

    <div class="results-table">
      <table>
        <thead>
          <tr>
            <th>키워드</th>
            <th>총 검색량</th>
            <th>PC 검색량</th>
            <th>모바일 검색량</th>
          </tr>
        </thead>
        <tbody id="resultsTableBody">
          <!-- 결과가 여기에 표시됩니다 -->
          <tr>
            <td colspan="4" class="loading">
              <i class="fa fa-info-circle"></i> 검색 결과가 여기에 표시됩니다.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="footer">
      <p>검색된 키워드의 데이터는 네이버 API 기준 데이터입니다.</p>
      <p>&copy; 2024 키워드 검색량 조회 서비스</p>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      let lastSearchedKeywords = [];
      let searchVolumeChart = null;

      // 천 단위 쉼표 포맷팅 함수
      function formatNumber(number) {
        if (number === 0 || number === '0' || number === '< 10') return '0';
        if (!number) return '-';
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      // 키워드 유효성 검사 함수
      function validateKeywords(keywordsText) {
        if (!keywordsText.trim()) {
          alert('검색할 키워드를 입력하세요.');
          return false;
        }

        // 쉼표로 구분된 키워드 배열 생성
        const keywords = keywordsText.split(',')
          .map(k => k.trim())
          .filter(k => k.length > 0);

        if (keywords.length === 0) {
          alert('유효한 키워드를 입력하세요.');
          return false;
        }

        if (keywords.length > 5) {
          alert('키워드는 최대 5개까지만 검색 가능합니다.');
          return false;
        }

        // 특수문자 체크 (쉼표 제외)
        const specialCharRegex = /[^\w\s가-힣ㄱ-ㅎㅏ-ㅣ]/g;
        for (const keyword of keywords) {
          if (specialCharRegex.test(keyword.replace(/,/g, ''))) {
            alert('키워드에 특수문자를 사용할 수 없습니다.');
            return false;
          }
        }

        // 이전 검색과 동일한지 확인
        const currentKeywordsStr = keywords.sort().join(',');
        const lastKeywordsStr = lastSearchedKeywords.sort().join(',');
        
        if (currentKeywordsStr === lastKeywordsStr) {
          alert('동일한 키워드입니다. 다른 키워드를 검색해주세요.');
          return false;
        }

        return keywords;
      }

      // 키워드 검색 함수
      function searchKeywords() {
        const keywordsText = $('#keywordInput').val();
        const keywords = validateKeywords(keywordsText);
        
        if (!keywords) return;

        // 버튼 비활성화
        $('#searchButton').prop('disabled', true);
        
        // 로딩 표시
        $('#resultsTableBody').html(`
          <tr>
            <td colspan="4" class="loading">
              <i class="fa fa-spinner fa-spin"></i> 키워드 검색량을 조회 중입니다...
            </td>
          </tr>
        `);
        
        // 그래프 숨기기
        $('#graphContainer').hide();
        
        // API 호출 타임스탬프
        const timestamp = new Date().getTime();
        
        // API 호출
        $.ajax({
          url: '/api/keywordSearch',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ keywords }),
          success: function(response) {
            console.log('API 응답:', response);
            
            // 응답 처리
            if (response.status === 'success' && response.results && response.results.length > 0) {
              // 테이블에 결과 표시
              displayResults(response.results);
              
              // 그래프에 결과 표시
              if (response.dataLab) {
                displayGraph(response.dataLab);
              }
              
              // 마지막 검색 키워드 업데이트
              lastSearchedKeywords = keywords;
            } else {
              // 결과가 없거나 오류 발생
              $('#resultsTableBody').html(`
                <tr>
                  <td colspan="4" class="no-results">
                    <div class="error-message">데이터를 가져올 수 없습니다.</div>
                    <div style="margin-top: 10px;">서버 응답: ${response.message || '알 수 없는 오류'}</div>
                    <div style="margin-top: 15px;">
                      <ul style="list-style-type: disc; padding-left: 20px; text-align: left;">
                        <li>네이버 API 키가 유효한지 확인하세요.</li>
                        <li>네트워크 연결 상태를 확인하세요.</li>
                        <li>잠시 후 다시 시도해보세요.</li>
                      </ul>
                    </div>
                  </td>
                </tr>
              `);
            }
          },
          error: function(xhr, status, error) {
            console.error('API 호출 오류:', error);
            
            // 오류 메시지 표시
            $('#resultsTableBody').html(`
              <tr>
                <td colspan="4" class="no-results">
                  <div class="error-message">서버 오류가 발생했습니다</div>
                  <div style="margin-top: 10px;">${xhr.status}: ${xhr.statusText || '알 수 없는 오류'}</div>
                  <div style="margin-top: 15px;">
                    <ul style="list-style-type: disc; padding-left: 20px; text-align: left;">
                      <li>서버 연결 상태를 확인하세요.</li>
                      <li>네이버 API 키가 유효한지 확인하세요.</li>
                      <li>잠시 후 다시 시도해보세요.</li>
                      <li>문제가 지속되면 관리자에게 문의하세요.</li>
                    </ul>
                  </div>
                </td>
              </tr>
            `);
          },
          complete: function() {
            // 버튼 활성화 (1초 후)
            setTimeout(function() {
              $('#searchButton').prop('disabled', false);
            }, 1000);
          }
        });
      }

      // 검색 결과 표시 함수
      function displayResults(results) {
        let tableHtml = '';
        let hasValidResults = false;
        
        results.forEach(result => {
          if (result.error) {
            // 오류 처리
            tableHtml += `
              <tr>
                <td>${result.keyword}</td>
                <td colspan="3" class="error-message">${result.error}</td>
              </tr>
            `;
          } else {
            // 성공 처리
            hasValidResults = true;
            tableHtml += `
              <tr>
                <td>
                  <a href="https://search.naver.com/search.naver?query=${encodeURIComponent(result.keyword)}" 
                     target="_blank" class="keyword-link">
                    ${result.keyword}
                    <i class="fa fa-external-link external-link"></i>
                  </a>
                </td>
                <td>${formatNumber(result.total)}</td>
                <td>${formatNumber(result.pc)}</td>
                <td>${formatNumber(result.mobile)}</td>
              </tr>
            `;
          }
        });
        
        if (!hasValidResults) {
          tableHtml = `
            <tr>
              <td colspan="4" class="no-results">
                <div class="error-message">모든 키워드에 대한 검색 결과를 가져오지 못했습니다.</div>
                <div style="margin-top: 15px;">
                  <ul style="list-style-type: disc; padding-left: 20px; text-align: left;">
                    <li>네트워크 연결 상태를 확인하세요.</li>
                    <li>잠시 후 다시 시도해보세요.</li>
                    <li>API 키가 유효한지 확인하세요.</li>
                  </ul>
                </div>
              </td>
            </tr>
          `;
        }
        
        $('#resultsTableBody').html(tableHtml);
      }

      // 그래프 표시 함수
      function displayGraph(dataLab) {
        // 그래프 데이터 준비
        const labels = []; // 월 정보를 담을 배열
        const datasets = []; // 키워드별 데이터셋을 담을 배열
        
        // 색상 배열
        const colors = [
          'rgb(0,199,60)',  // Green
          'rgb(234,84,151)', // Pink
          'rgb(147,87,250)', // Purple
          'rgb(252,176,45)', // Yellow
          'rgb(106,209,194)' // Teal
        ];
        
        // 기존 그래프 파괴
        if (searchVolumeChart) {
          searchVolumeChart.destroy();
        }
        
        // 월별 데이터가 없을 경우 임시 데이터 생성
        if (!dataLab.results || dataLab.results.length === 0) {
          // 최근 12개월 데이터 생성
          const today = new Date();
          for (let i = 11; i >= 0; i--) {
            const date = new Date(today);
            date.setMonth(today.getMonth() - i);
            const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-01`;
            labels.push(yearMonth);
          }
          
          // 임시 데이터셋 생성
          $('#graphContainer').hide();
          return;
        }
        
        // 실제 월별 데이터 처리
        const startDate = new Date(dataLab.startDate);
        const endDate = new Date(dataLab.endDate);
        let currentDate = new Date(startDate);
        
        // 각 월별 라벨 생성
        while (currentDate <= endDate) {
          const yearMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
          labels.push(yearMonth);
          
          currentDate.setMonth(currentDate.getMonth() + 1);
        }
        
        // 키워드별 데이터셋 생성
        dataLab.results.forEach((result, index) => {
          const keyword = result.keywords;
          const data = [];
          
          // 각 월별 데이터 매핑
          labels.forEach(label => {
            // 해당 월의 데이터 찾기
            const monthData = result.data.find(item => item.period === label);
            
            // 데이터가 있으면 사용, 없으면 0으로 설정
            data.push(monthData ? monthData.ratio : 0);
          });
          
          // 키워드 데이터셋 추가
          datasets.push({
            label: keyword,
            data: data,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            borderWidth: 2,
            pointRadius: 3,
            pointHoverRadius: 5,
            tension: 0.1,
            fill: false
          });
        });
        
        // 그래프 생성
        const ctx = document.getElementById('searchVolumeChart').getContext('2d');
        searchVolumeChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels.map(label => {
              const date = new Date(label);
              return `${date.getFullYear()}년 ${date.getMonth() + 1}월`;
            }),
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            },
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  usePointStyle: true,
                  padding: 15
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.dataset.label}: ${context.raw}%`;
                  }
                }
              }
            }
          }
        });
        
        // 그래프 표시
        $('#graphContainer').show();
      }

      // 검색 버튼 클릭 이벤트
      $('#searchButton').click(function() {
        searchKeywords();
      });

      // 엔터 키 이벤트
      $('#keywordInput').keypress(function(e) {
        if (e.which === 13 && !e.shiftKey) {
          e.preventDefault();
          searchKeywords();
        }
      });

      // 페이지 로드 시 기본 키워드 설정
      $('#keywordInput').val('네이버');
    });
  </script>
</body>
</html>